<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Masjid Mekarindah</title>
    <style>
        :root { 
            --primary: rgba(0, 77, 64, 0.9); 
            --accent: #ffc107;               
            --font-main: 2.8rem;             
            --glass: rgba(0, 0, 0, 0.8);
            --blur: blur(15px);
            --danger: rgba(183, 28, 28, 0.95);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }

        body {
            overflow: hidden; 
            background-color: #111;
            color: white;
            height: 100vh;
            width: 100vw;
        }

        /* Background Layer */
        #bg-slider {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2; background-size: cover; background-position: center;
            transition: background-image 2s ease-in-out;
            background-color: #222; /* Warna cadangan jika gambar gagal load */
        }

        /* GRID LAYOUT STABIL */
        .main-wrapper {
            display: grid;
            grid-template-rows: auto 1fr 180px; /* Kunci baris bawah setinggi 180px */
            height: 100vh;
            padding: 20px;
            padding-bottom: 90px; /* Ruang Marquee */
            position: relative;
            z-index: 1;
            gap: 10px;
        }

        /* --- 1. ATAS --- */
        .top-section { display: flex; justify-content: space-between; align-items: flex-start; }
        .left-side { display: flex; flex-direction: column; gap: 8px; }
        .masjid-info {
            background: var(--primary); padding: 10px 30px; border-radius: 10px;
            backdrop-filter: var(--blur); border: 1px solid rgba(255,255,255,0.2);
        }
        .masjid-info h1 { font-size: 2.5rem; text-transform: uppercase; text-shadow: 2px 2px 4px black; }

        .admin-box {
            background: var(--glass); backdrop-filter: var(--blur); padding: 8px 20px;
            border-radius: 10px; border-left: 5px solid var(--accent); min-width: 350px;
        }
        .admin-box span { font-size: 0.8rem; color: var(--accent); text-transform: uppercase; }
        .admin-box h2 { font-size: 1.5rem; }

        .right-side { text-align: right; }
        .clock-section { background: var(--glass); padding: 10px 20px; border-radius: 10px; backdrop-filter: var(--blur); }
        #jam { font-size: 3rem; font-weight: bold; color: var(--accent); line-height: 1; }
        .date { font-size: 1.2rem; margin-top: 5px; }
        
        #next-sholat-box {
            background: var(--danger); padding: 8px 15px; border-radius: 8px;
            font-size: 1.1rem; font-weight: bold; margin-top: 8px; display: none;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* --- 2. TENGAH (Event Area) --- */
        .middle-section { 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden; 
        }
        .event-box-dynamic {
            width: 70%; max-height: 95%; background: rgba(0, 0, 0, 0.9); 
            backdrop-filter: blur(20px); border-radius: 15px; border: 3px solid var(--accent); 
            padding: 20px; display: flex; align-items: center; gap: 20px;
            animation: slideInUp 0.8s ease-out;
        }
        @keyframes slideInUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .event-img { width: 180px; height: 180px; object-fit: cover; border-radius: 10px; border: 2px solid var(--accent); }
        .event-text h2 { font-size: 2rem; color: var(--accent); margin-bottom: 5px; }
        .event-text p { font-size: 1.2rem; color: #fff; }

        /* --- 3. BAWAH (Jadwal Sholat) --- */
        .sholat-container { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; 
            align-self: end; /* Selalu di dasar grid */
        }
        .sholat-box {
            background: var(--primary); backdrop-filter: var(--blur); padding: 15px 5px;
            text-align: center; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);
        }
        .sholat-box.active { background: var(--danger) !important; transform: scale(1.05); border: 2px solid white; }
        .sholat-box h3 { font-size: 1.3rem; color: var(--accent); text-transform: uppercase; }
        .sholat-box p { font-size: 2.3rem; font-weight: bold; }

        footer {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #000;
            padding: 10px 0; border-top: 3px solid var(--accent); z-index: 100;
        }
        marquee { font-size: 1.8rem; color: white; }
    </style>
</head>
<body>

    <div id="bg-slider"></div>

    <div class="main-wrapper">
        <div class="top-section">
            <div class="left-side">
                <div class="masjid-info"><h1>Masjid Mekarindah</h1></div>
                <div class="admin-box"><span>Petugas Jumat</span><h2 id="dispPetugas">-</h2></div>
                <div class="admin-box"><span>Saldo Kas Masjid</span><h2 id="dispSaldo">Rp 0</h2></div>
            </div>
            <div class="right-side">
                <div class="clock-section">
                    <span id="jam">00:00:00</span>
                    <div class="date" id="tgl-masehi">---</div>
                    <div class="date" id="tgl-hijri" style="color:var(--accent)">---</div>
                </div>
                <div id="next-sholat-box">Countdown...</div>
            </div>
        </div>

        <div class="middle-section" id="event-container"></div>

        <div class="sholat-container">
            <div id="box-Subuh" class="sholat-box"><h3>Subuh</h3><p id="Subuh">--:--</p></div>
            <div id="box-Dzuhur" class="sholat-box"><h3>Dzuhur</h3><p id="Dzuhur">--:--</p></div>
            <div id="box-Ashar" class="sholat-box"><h3>Ashar</h3><p id="Ashar">--:--</p></div>
            <div id="box-Maghrib" class="sholat-box"><h3>Maghrib</h3><p id="Maghrib">--:--</p></div>
            <div id="box-Isya" class="sholat-box"><h3>Isya</h3><p id="Isya">--:--</p></div>
        </div>
    </div>

    <footer><marquee scrollamount="4" id="running-text">Memuat...</marquee></footer>

    <script>
        const BIN_ID = '696b9011ae596e708fe2b6e5'; 
        const KEY = '$2a$10$wOmw1bmVgdzweWhDNL7ujO8t2zGoWPiQzeLE/IeIhZg//vicMOJnq';
        const images = ['bg1.jpg', 'bg2.jpg', 'bg3.jpg', 'bg4.jpg']; // PASTIKAN HURUF KECIL SEMUA
        let bgIndex = 0;
        let jadwalSkg = {};

        function updateClock() {
            const now = new Date();
            document.getElementById('jam').innerText = now.toLocaleTimeString('id-ID', { hour12: false });
            document.getElementById('tgl-masehi').innerText = now.toLocaleDateString('id-ID', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
            if (Object.keys(jadwalSkg).length > 0) processTimeLogic();
        }

        function processTimeLogic() {
            const now = new Date();
            const cur = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            let next = null; let min = Infinity; let active = null;
            const names = ['Subuh', 'Dzuhur', 'Ashar', 'Maghrib', 'Isya'];
            names.forEach(n => {
                if(!jadwalSkg[n]) return;
                const [h, m] = jadwalSkg[n].split(':').map(Number);
                const s = h * 3600 + m * 60;
                document.getElementById(`box-${n}`).classList.remove('active');
                if (s - cur > 0 && s - cur < min) { min = s - cur; next = { n, s: min }; }
                if (cur >= s && cur < s + 1800) active = n;
            });
            if (active) document.getElementById(`box-${active}`).classList.add('active');
            const cb = document.getElementById('next-sholat-box');
            if (next) {
                cb.style.display = 'inline-block';
                const h = Math.floor(next.s / 3600); const m = Math.floor((next.s % 3600) / 60); const sc = next.s % 60;
                cb.innerText = `Menuju ${next.n}: ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`;
            }
        }

        async function syncData() {
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { 'X-Master-Key': KEY } });
                const data = (await res.json()).record;
                document.getElementById('dispSaldo').innerText = data.saldo;
                document.getElementById('dispPetugas').innerText = data.petugas;
                
                const container = document.getElementById('event-container');
                const isActive = (data.eventActive === "true" || data.eventActive === true);

                if (isActive) {
                    container.innerHTML = `<div class="event-box-dynamic">
                        <img src="${data.eventImg}" class="event-img" onerror="this.src='https://via.placeholder.com/200?text=Gambar+Tidak+Ada'">
                        <div class="event-text">
                            <h4 style="color:var(--accent)">${data.eventDate}</h4>
                            <h2>${data.eventTitle}</h2>
                            <p>${data.eventDesc}</p>
                        </div>
                    </div>`;
                } else { container.innerHTML = ''; }

                const resH = await fetch('https://api.hadith.gading.dev/books/bukhari?range=1-50');
                const dataH = await resH.json();
                const hT = dataH.data.hadiths[Math.floor(Math.random() * 50)].id.substring(0, 200);
                document.getElementById('running-text').innerText = `Selamat Datang - ${data.marquee} | Hadits: ${hT}...`;
            } catch (e) { console.log("Sync Error", e); }
        }

        async function getJadwal() {
            try {
                // Gunakan HTTPS selalu
                const res = await fetch('https://api.aladhan.com/v1/timingsByCity?city=Cikarang&country=Indonesia&method=11');
                const d = await res.json();
                const t = d.data.timings;
                jadwalSkg = { Subuh: t.Fajr, Dzuhur: t.Dhuhr, Ashar: t.Asr, Maghrib: t.Maghrib, Isya: t.Isha };
                for (let n in jadwalSkg) document.getElementById(n).innerText = jadwalSkg[n];
                document.getElementById('tgl-hijri').innerText = `${d.data.date.hijri.day} ${d.data.date.hijri.month.en} ${d.data.date.hijri.year} H`;
            } catch (e) { console.log("Jadwal Error", e); }
        }

        function changeBg() {
            const bg = document.getElementById('bg-slider');
            // Tambahkan console log untuk debug di Vercel
            console.log("Loading BG:", images[bgIndex]);
            bg.style.backgroundImage = `url('${window.location.origin}/${images[bgIndex]}')`;
            bgIndex = (bgIndex + 1) % images.length;
        }

        setInterval(updateClock, 1000); 
        setInterval(changeBg, 300000); 
        setInterval(getJadwal, 3600000); 
        setInterval(syncData, 1800000);
        
        // Jalankan segera
        updateClock(); changeBg(); getJadwal(); syncData();
    </script>
</body>
</html>